<!DOCTYPE html>
<html>
  <head>
    <title>Odd One Out Experiment</title>
    <script src="https://unpkg.com/jspsych@8.2.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-text@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload@2.1.0"></script>
    <link href="https://unpkg.com/jspsych@8.2.2/css/jspsych.css" rel="stylesheet" type="text/css" />
    <style>
      .stimulus-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
        margin-top: 50px;
      }
      .word-button {
        font-size: 24px;
        padding: 20px 40px;
        min-width: 200px;
        cursor: pointer;
      }
    </style>
  </head>
  <body></body>
  <script>

    /* Stimuli list */
    const stimuli = [
      "cheval", "renard", "loup", "ours", "cygne", "oie", "hibou", "requin", "crevette", "homard", "méduse"
    ];

    /* Triplet indices */
    const triplet_indices = [
      [2,6,7], [1,4,9], [5,9,8], [0,9,2], [7,5,2], [6,4,8], [4,8,10], [10,7,1], [1,6,0],
      [0,5,3], [0,1,4], [7,8,3], [9,7,3], [2,3,0], [3,8,10], [0,3,6], [1,8,4], [1,10,4],
      [2,1,9], [10,9,1], [1,3,0], [4,7,5], [4,2,3], [6,5,7], [6,8,3], [0,1,5], [10,9,6],
      [0,9,7], [5,6,9], [10,9,7], [9,8,2], [3,2,1], [0,8,4], [1,2,0], [0,6,9], [3,5,1],
      [6,1,2], [7,3,10], [10,0,6], [0,5,2], [1,8,9], [1,4,7], [3,4,8], [5,8,3], [9,10,5],
      [1,10,2], [2,4,1], [0,9,8], [8,6,5], [6,2,4], [0,5,10], [0,4,3], [1,10,5], [7,8,6],
      [3,2,7], [1,5,9], [4,2,8], [2,10,4], [5,4,2], [4,10,5], [6,9,8], [7,0,2], [3,4,9],
      [5,0,4], [10,3,1], [9,3,5], [8,7,2], [10,2,8], [6,5,1], [5,2,1], [10,1,8], [6,10,3],
      [4,10,3], [0,4,9], [2,3,6], [5,4,3], [8,9,10], [1,0,8], [1,7,2], [0,6,2], [1,4,3],
      [8,5,10], [6,2,5], [5,0,7], [0,1,7], [8,10,6], [0,8,10], [7,10,0], [10,9,3], [4,3,7],
      [9,6,1], [3,2,10], [9,5,7], [2,0,8], [4,9,5], [8,5,1], [9,4,6], [5,10,6], [3,1,7],
      [8,10,7], [8,5,7], [0,10,4], [1,10,6], [4,6,0], [2,5,9], [6,7,9], [5,7,1], [7,4,8],
      [3,9,1], [6,5,0], [3,5,2], [1,5,4], [6,10,2], [9,4,8], [10,2,0], [10,0,9], [0,6,7],
      [8,6,0], [1,7,9], [2,6,9], [3,9,6], [1,7,6], [7,3,0], [7,4,9], [8,4,5], [8,2,3],
      [5,9,0], [8,2,5], [10,6,7], [3,1,6], [8,6,2], [4,3,6], [10,7,4], [5,7,3], [7,0,4],
      [7,10,2], [7,2,9], [7,10,5], [7,3,6], [2,7,4], [0,8,3], [3,0,10], [4,2,0], [4,10,6],
      [4,6,7], [2,9,4], [1,2,8], [8,3,1], [0,5,8], [5,10,3], [1,9,0], [4,6,5], [9,10,4],
      [8,7,9], [9,2,10], [6,3,5], [8,6,1], [9,8,3], [2,9,3], [5,2,10], [1,8,7], [0,10,1],
      [3,0,9], [7,0,8], [6,4,1]
    ];

    /* Convert indices to words and create trial stimuli */
    const test_stimuli = triplet_indices.map((indices, triplet_num) => {
      return {
        triplet_number: triplet_num,
        index1: indices[0],
        index2: indices[1],
        index3: indices[2],
        word1: stimuli[indices[0]],
        word2: stimuli[indices[1]],
        word3: stimuli[indices[2]]
      };
    });

    console.log(`Loaded ${test_stimuli.length} triplets`);

    /* Initialize jsPsych */
    var jsPsych = initJsPsych({
      on_finish: function() {
        // Experiment is already finished, data already sent
        console.log("Experiment complete");
      }
    });

    /* Create timeline */
    var timeline = [];

    /* Welcome and name entry */
    var welcome_name = {
      type: jsPsychSurveyText,
      preamble: "<p>Salut :)))</p>",
      questions: [
        {prompt: "Quel est votre nom ?", name: 'participant_name'}
      ],
      data: {task: 'name_entry'}
    };
    timeline.push(welcome_name);

    /* Instructions */
    var instructions = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <p>Dans cette tâche, vous verrez trois mots à l'écran.</p>
        <p>Vous devrez décider lequel est le plus différent des autres.</p>
        <p><strong>Cliquez sur le mot</strong> que vous pensez être l'intrus.</p>
        <p>Appuyez sur n'importe quelle touche pour commencer.</p>
      `
    };
    timeline.push(instructions);

    /* Odd one out trial */
    var test = {
      type: jsPsychHtmlButtonResponse,
      stimulus: '<div class="stimulus-container"><p style="font-size: 18px;">Quel mot est l\'intrus ?</p></div>',
      choices: function() {
        const word1 = jsPsych.evaluateTimelineVariable('word1');
        const word2 = jsPsych.evaluateTimelineVariable('word2');
        const word3 = jsPsych.evaluateTimelineVariable('word3');
        return [word1, word2, word3];
      },
      button_html: function(choice) {
        return `<button class="jspsych-btn word-button">${choice}</button>`;
      },
      data: function() {
        return {
          task: 'response',
          triplet_number: jsPsych.evaluateTimelineVariable('triplet_number'),
          index1: jsPsych.evaluateTimelineVariable('index1'),
          index2: jsPsych.evaluateTimelineVariable('index2'),
          index3: jsPsych.evaluateTimelineVariable('index3'),
          word1: jsPsych.evaluateTimelineVariable('word1'),
          word2: jsPsych.evaluateTimelineVariable('word2'),
          word3: jsPsych.evaluateTimelineVariable('word3')
        };
      },
      on_finish: function(data) {
        // Store which word was selected
        const choices = [data.word1, data.word2, data.word3];
        data.selected_position = data.response;
        data.selected_word = choices[data.response];
        
        // Map button position back to original index
        const indices = [data.index1, data.index2, data.index3];
        data.selected_index = indices[data.response];
      }
    };

    /* Test procedure with randomization */
    var test_procedure = {
      timeline: [test],
      timeline_variables: test_stimuli,
      randomize_order: true,
      on_timeline_finish: async function() {
        // Get all response data
        const data = jsPsych.data.get().filter({task: 'response'});
        const participant_name = jsPsych.data.get().filter({task: 'name_entry'}).values()[0].response.participant_name;

        // Prepare data as JSON objects
        const rows = data.values().map(trial => ({
          participant_name: participant_name,
          triplet_number: trial.triplet_number,
          index1: trial.index1,
          index2: trial.index2,
          index3: trial.index3,
          word1: trial.word1,
          word2: trial.word2,
          word3: trial.word3,
          selected_position: trial.selected_position,
          selected_index: trial.selected_index,
          selected_word: trial.selected_word,
          rt: trial.rt
        }));

        // Send results to Google Apps Script
        try {
          await fetch("https://script.google.com/macros/s/AKfycbydTh0tb92Lw0j04mnefum24MbAQe5b3Mhlguy1DJXq9VFzmwfwWXKwp4J1xD2R5xfodg/exec", {
            method: "POST",
            mode: "no-cors",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(rows)
          });
          console.log("Results sent successfully!");
        } catch (err) {
          console.error("Error sending data:", err);
        }
      }
    };

    timeline.push(test_procedure);

    /* Thank you screen - automatically ends after data is sent */
    var thank_you = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <p>Merci d'avoir participé à cette expérience !</p>
        <p>Vos résultats ont été envoyés avec succès.</p>
        <p>Vous pouvez fermer cette fenêtre.</p>
      `,
      trial_duration: 3000,
      response_ends_trial: false
    };
    timeline.push(thank_you);

    /* Start the experiment */
    jsPsych.run(timeline);

  </script>
</html>